<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Skomorokha's Quest</title>
    <style>
        :root { --primary: #ff9800; --secondary: #fff3e0; --gold: #ffeb3b; --green: #4caf50; --red: #f44336; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Comic Sans MS', 'Arial', sans-serif; }
        canvas { display: block; touch-action: none; }
        
        /* Overlays & Cards */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex;
            flex-direction: column; justify-content: center; align-items: center; z-index: 2000;
            color: white; text-align: center; padding: 20px; box-sizing: border-box;
        }
        .card {
            background: white; color: #333; padding: 30px; border-radius: 30px;
            max-width: 500px; width: 95%; border: 6px solid var(--primary);
            position: relative; max-height: 90vh; overflow-y: auto;
        }
        
        /* Buttons */
        .btn {
            background: var(--primary); color: white; border: none; padding: 15px 40px;
            font-size: 24px; font-weight: bold; border-radius: 50px; cursor: pointer;
            margin-top: 20px; transition: 0.3s; box-shadow: 0 4px 0 #e65100;
        }
        .btn-small { padding: 10px 20px; font-size: 16px; margin: 5px; }
        
        /* Quiz */
        #quiz-overlay { display: none; z-index: 3000; }
        .options-grid { display: grid; gap: 10px; margin-top: 20px; width: 100%; }
        .opt-btn { 
            background: #fff8e1; border: 3px solid var(--secondary); padding: 15px; 
            border-radius: 15px; cursor: pointer; font-size: 20px; font-weight: bold; 
            color: #795548; transition: all 0.2s ease;
        }
        .correct { background-color: var(--green) !important; color: white !important; border-color: #2e7d32 !important; transform: scale(1.05); }
        .wrong { background-color: var(--red) !important; color: white !important; border-color: #c62828 !important; }
        .disabled { pointer-events: none; }
        
        /* UI Layer */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; pointer-events: none; padding: 15px; box-sizing: border-box; color: white; z-index: 1000;}
        .top-left { position: absolute; top: 20px; left: 20px; }
        .top-right { position: absolute; top: 20px; right: 20px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; pointer-events: auto; }
        
        #progress-bar { width: 200px; height: 20px; background: rgba(255,255,255,0.2); border-radius: 10px; border: 2px solid #fff; overflow: hidden; margin-top: 5px; }
        #progress-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.3s; }
        .indicator-box { background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; border: 3px solid var(--primary); font-weight: bold; font-size: 18px; text-align: right;}
        
        .power-bar-container { width: 140px; height: 12px; background: #444; border-radius: 6px; margin-top: 5px; border: 1px solid #fff; }
        #power-fill { width: 0%; height: 100%; background: var(--gold); border-radius: 6px; }
        #combo-msg { position: absolute; font-size: 50px; color: var(--gold); font-weight: bold; text-shadow: 3px 3px 0 #000; pointer-events: none; display: none; z-index: 1500;}
        
        /* Editor Styles */
        #editor-overlay { display: none; z-index: 4000; }
        .editor-group { margin-bottom: 15px; text-align: left; }
        .editor-group label { font-weight: bold; display: block; margin-bottom: 5px; color: #444;}
        .editor-group select, .editor-group textarea { width: 100%; padding: 10px; border-radius: 10px; border: 2px solid #ccc; box-sizing: border-box; font-family: inherit;}
        #editor-btn { background: #333; pointer-events: auto; font-size: 14px; padding: 8px 15px; cursor: pointer; border: 2px solid white; border-radius: 15px; color: white; margin-bottom: 10px;}
        
        /* Lang Switcher */
        .lang-switch { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); pointer-events: auto; z-index: 2500;}
        .lang-btn { background: #fff; border: 2px solid var(--primary); padding: 5px 10px; border-radius: 10px; cursor: pointer; font-weight: bold;}
    </style>
</head>
<body>

<div class="lang-switch" id="lang-container">
    <button class="lang-btn" onclick="setLang('en')">EN</button>
    <button class="lang-btn" onclick="setLang('ru')">RU</button>
    <button class="lang-btn" onclick="setLang('de')">DE</button>
</div>

<div id="start-screen" class="overlay">
    <div class="card">
        <h1 id="ui-title" style="color: var(--primary); font-size: 32px;">Hi! I am Skomorokha! ü§°</h1>
        <p id="ui-desc" style="font-size: 20px;">I give pancakes to everyone! Help me throw them and learn <b>Past Simple</b>!</p>
        <button class="btn" id="ui-start-btn" onclick="startGame()">LET'S GO! ‚òÄÔ∏è</button>
    </div>
</div>

<div id="end-screen" class="overlay" style="display: none;">
    <div class="card">
        <h1 id="ui-end-title" style="color: var(--primary); font-size: 40px;">GREAT! üåû</h1>
        <p id="ui-end-desc" style="font-size: 24px;">You are a Master and you know English verbs!</p>
        <button class="btn" id="ui-restart-btn" onclick="location.reload()">PLAY AGAIN!</button>
    </div>
</div>

<div id="quiz-overlay" class="overlay">
    <div class="card">
        <h2 id="ui-quiz-title" style="color: var(--primary); font-size: 26px;">Power Up! ‚ú®</h2>
        <p id="quiz-question" style="font-size: 22px; font-weight: bold; margin: 15px 0; color: #444;"></p>
        <div class="options-grid" id="options"></div>
    </div>
</div>

<div id="editor-overlay" class="overlay">
    <div class="card">
        <h2 style="color: var(--primary); margin-top:0;">‚öôÔ∏è Game Editor</h2>
        
        <div class="editor-group">
            <label>Visual Theme / Projectile:</label>
            <select id="edit-theme" onchange="applySettings()">
                <option value="pancake">ü•û Pancakes & Standard Background</option>
                <option value="pirate">ü™ô Pirate Coins & Golden Sand</option>
            </select>
        </div>

        <div class="editor-group">
            <label>Target Goal (Points):</label>
            <select id="edit-goal" onchange="applySettings()">
                <option value="1000">1000 (Short)</option>
                <option value="3000" selected>3000 (Normal)</option>
                <option value="5000">5000 (Long)</option>
            </select>
        </div>

        <div class="editor-group">
            <label>Grammar Bank (JSON format):</label>
            <textarea id="edit-grammar" rows="8"></textarea>
        </div>

        <button class="btn btn-small" onclick="saveEditor()">Save & Close</button>
    </div>
</div>

<div id="ui-layer">
    <div class="top-left">
        <div id="ui-score-title" style="font-weight: bold; text-shadow: 1px 1px 2px #000;">Score (Goal: 3000)</div>
        <div id="progress-bar"><div id="progress-fill"></div></div>
    </div>
    <div class="top-right">
        <button id="editor-btn" onclick="openEditor()">‚öôÔ∏è Editor</button>
        <div class="indicator-box" id="wind-ui">Wind: 0</div>
        <div class="indicator-box"><span id="ui-power">Power</span><div class="power-bar-container"><div id="power-fill"></div></div></div>
    </div>
</div>
<div id="combo-msg">WOW!</div>
<canvas id="game-canvas"></canvas>

<script>
    // --- TRANSLATIONS ---
    const i18n = {
        en: {
            title: "Hi! I am Skomorokha! ü§°",
            desc: "Help me throw items and learn <b>Past Simple</b>!",
            start: "LET'S GO! ‚òÄÔ∏è",
            endTitle: "GREAT! üåû",
            endDesc: "You are a Master and you know English verbs!",
            restart: "PLAY AGAIN!",
            quizTitle: "Power Up! ‚ú®",
            scoreTitle: "Score",
            power: "Power",
            wind: "Wind"
        },
        ru: {
            title: "–ü—Ä–∏–≤–µ—Ç! –Ø –°–∫–æ–º–æ—Ä–æ—Ö! ü§°",
            desc: "–ü–æ–º–æ–≥–∏ –º–Ω–µ –±—Ä–æ—Å–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã –∏ —É—á–∏—Ç—å <b>Past Simple</b>!",
            start: "–ü–û–ì–ù–ê–õ–ò! ‚òÄÔ∏è",
            endTitle: "–û–¢–õ–ò–ß–ù–û! üåû",
            endDesc: "–¢—ã –Ω–∞—Å—Ç–æ—è—â–∏–π –ú–∞—Å—Ç–µ—Ä –∏ –∑–Ω–∞–µ—à—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –≥–ª–∞–≥–æ–ª—ã!",
            restart: "–ò–ì–†–ê–¢–¨ –ï–©–ï!",
            quizTitle: "–°—É–ø–µ—Ä—Å–∏–ª–∞! ‚ú®",
            scoreTitle: "–°—á–µ—Ç",
            power: "–°–∏–ª–∞",
            wind: "–í–µ—Ç–µ—Ä"
        },
        de: {
            title: "Hallo! Ich bin Skomorokha! ü§°",
            desc: "Hilf mir, Gegenst√§nde zu werfen und <b>Past Simple</b> zu lernen!",
            start: "LOS GEHT'S! ‚òÄÔ∏è",
            endTitle: "TOLL! üåû",
            endDesc: "Du bist ein Meister und kennst die englischen Verben!",
            restart: "NOCHMAL SPIELEN!",
            quizTitle: "Aufladen! ‚ú®",
            scoreTitle: "Punkte",
            power: "Kraft",
            wind: "Wind"
        }
    };

    let currentLang = 'en';

    function setLang(lang) {
        currentLang = lang;
        const t = i18n[lang];
        document.getElementById('ui-title').innerHTML = t.title;
        document.getElementById('ui-desc').innerHTML = t.desc;
        document.getElementById('ui-start-btn').innerText = t.start;
        document.getElementById('ui-end-title').innerText = t.endTitle;
        document.getElementById('ui-end-desc').innerText = t.endDesc;
        document.getElementById('ui-restart-btn').innerText = t.restart;
        document.getElementById('ui-quiz-title').innerText = t.quizTitle;
        document.getElementById('ui-score-title').innerText = `${t.scoreTitle} (Goal: ${targetScore})`;
        document.getElementById('ui-power').innerText = t.power;
        
        // Update wind if playing
        if(gameState === 'PLAY') {
            document.getElementById('wind-ui').innerText = `${t.wind}: ${wind > 0 ? '‚Üí' : '‚Üê'} ${(Math.abs(wind)*100).toFixed(0)}`;
        }
    }

    // --- GAME DATA & SETTINGS ---
    let grammarBank = [
        { q: "Yesterday I ___ (go) to the park.", a: ["went", "goed", "gone"], c: 0 },
        { q: "She ___ (eat) a big apple.", a: ["eated", "ate", "aten"], c: 1 },
        { q: "We ___ (see) a funny bird.", a: ["saw", "seed", "seen"], c: 0 },
        { q: "He ___ (buy) a new toy.", a: ["buyed", "bought", "boughten"], c: 1 }
    ];
    
    let targetScore = 3000;
    let projectileChar = 'ü•û';
    let bgColor = null; // null means use default background image

    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    
    let questionPool = [...grammarBank]; 
    let images = {}, isLoaded = false, score = 0, combo = 0, gameState = 'START';
    let cupid, target, note, particles = [];
    let mouse = { x: 0, y: 0, down: false };
    let wind = 0;

    const assets = {
        bg: 'https://i.postimg.cc/rmvWTnyw/Dizajn-bez-nazvania-10.png',
        cupid: 'https://i.postimg.cc/66vncXzr/Dizajn-bez-nazvania-9.png',
        people: [
            'https://i.postimg.cc/VLPMHVVY/10.png', 'https://i.postimg.cc/Hs05G9qT/2.png',
            'https://i.postimg.cc/jd6NV4pY/3.png', 'https://i.postimg.cc/8PdW8m28/4.png'
        ]
    };

    // --- EDITOR LOGIC ---
    function openEditor() {
        document.getElementById('editor-overlay').style.display = 'flex';
        document.getElementById('edit-grammar').value = JSON.stringify(grammarBank, null, 2);
    }

    function saveEditor() {
        try {
            const parsed = JSON.parse(document.getElementById('edit-grammar').value);
            if(Array.isArray(parsed)) {
                grammarBank = parsed;
                questionPool = [...grammarBank];
            }
        } catch (e) {
            alert("Invalid JSON format in Grammar Bank!");
            return;
        }
        applySettings();
        document.getElementById('editor-overlay').style.display = 'none';
    }

    function applySettings() {
        const theme = document.getElementById('edit-theme').value;
        if(theme === 'pirate') {
            projectileChar = 'ü™ô';
            bgColor = '#d4af37'; // Golden Sand Color
        } else {
            projectileChar = 'ü•û';
            bgColor = null;
        }

        targetScore = parseInt(document.getElementById('edit-goal').value);
        setLang(currentLang); // refresh goal text
        updateUI();
    }

    // --- CORE GAME LOGIC ---
    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('lang-container').style.display = 'none'; // hide lang switch during game
        gameState = 'PLAY';
        resetGameScene();
    }

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        if(isLoaded && gameState === 'PLAY') resetGameScene();
    }

    function resetGameScene() {
        cupid = { x: canvas.width - 300, baseY: canvas.height / 2 - 100, y: 0, w: 140, h: 170, phase: Math.random()*20 };
        note = { active: false, x: 0, y: 0, vx: 0, vy: 0, rot: 0 };
        spawnTarget();
        wind = (Math.random() * 0.44 - 0.22);
        
        const t = i18n[currentLang];
        document.getElementById('wind-ui').innerText = `${t.wind}: ${wind > 0 ? '‚Üí' : '‚Üê'} ${(Math.abs(wind)*100).toFixed(0)}`;
        document.getElementById('power-fill').style.width = '0%';
    }

    function spawnTarget() {
        const url = assets.people[Math.floor(Math.random() * assets.people.length)];
        target = { x: 80 + Math.random() * (canvas.width * 0.3), y: canvas.height * 0.58, w: 160, h: 210, img: images[url], hit: false };
    }

    function loop() {
        if(gameState === 'PLAY') {
            // Background logic
            if(bgColor) {
                ctx.fillStyle = bgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                // Draw some 'sand' details implicitly via color
            } else {
                ctx.drawImage(images[assets.bg], 0, 0, canvas.width, canvas.height);
            }
            
            cupid.phase += 0.03;
            cupid.y = cupid.baseY + Math.sin(cupid.phase) * 180;
            
            if(target.hit) { ctx.save(); ctx.shadowBlur = 40; ctx.shadowColor = "#ff9800"; }
            ctx.drawImage(target.img, target.x, target.y, target.w, target.h);
            ctx.restore();
            
            ctx.drawImage(images[assets.cupid], cupid.x, cupid.y, cupid.w, cupid.h);
            
            if(mouse.down && !note.active) {
                const sx = cupid.x + 20, sy = cupid.y + 70;
                const dist = Math.hypot(sx - mouse.x, sy - mouse.y);
                document.getElementById('power-fill').style.width = Math.min(100, (dist / 250) * 100) + '%';
            }
            
            if(note.active) {
                note.vx += wind; note.vy += 0.22; note.x += note.vx; note.y += note.vy; note.rot += 0.25;
                
                if(Math.random() > 0.5) {
                    particles.push({ x: note.x, y: note.y, vx: 0, vy: 0, life: 0.6, size: 10 + Math.random()*10, char: projectileChar });
                }
                
                // Draw Projectile
                ctx.save(); ctx.translate(note.x, note.y); ctx.rotate(note.rot);
                ctx.font = '40px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(projectileChar, 0, 0);
                ctx.restore();
                
                const padding = 35; 
                if(note.x > target.x + padding && note.x < target.x + target.w - padding && 
                   note.y > target.y + padding && note.y < target.y + target.h - padding) {
                    target.hit = true; note.active = false; combo++;
                    score += 50; updateUI();
                    createExplosion(note.x, note.y);
                    if(combo > 1) showCombo();
                    setTimeout(resetGameScene, 800);
                } else if(note.y > canvas.height || note.x < 0 || note.x > canvas.width) {
                    note.active = false; combo = 0; showQuiz();
                }
            }
            
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                ctx.globalAlpha = p.life; ctx.font = p.size + 'px serif';
                ctx.fillText(p.char, p.x, p.y);
                if(p.life <= 0) particles.splice(i, 1);
            });
            ctx.globalAlpha = 1;
        }
        requestAnimationFrame(loop);
    }

    function updateUI() {
        document.getElementById('progress-fill').style.width = Math.min(100, (score/targetScore)*100) + '%';
        if(score >= targetScore) { gameState = 'END'; document.getElementById('end-screen').style.display = 'flex'; }
    }

    function createExplosion(x, y) {
        for(let i=0; i<12; i++) {
            particles.push({ x, y, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15, life:1, size:Math.random()*20+20, char: projectileChar });
        }
    }

    function showCombo() {
        const el = document.getElementById('combo-msg');
        el.style.display = 'block'; el.style.left = target.x + 'px'; el.style.top = target.y - 50 + 'px';
        el.innerText = `COMBO x${combo}!`; setTimeout(() => el.style.display = 'none', 1000);
    }

    function showQuiz() {
        gameState = 'QUIZ';
        if (questionPool.length === 0) questionPool = [...grammarBank];
        const rIndex = Math.floor(Math.random() * questionPool.length);
        const task = questionPool.splice(rIndex, 1)[0];
        document.getElementById('quiz-question').innerText = task.q;
        const optDiv = document.getElementById('options'); 
        optDiv.innerHTML = '';
        task.a.forEach((text, i) => {
            const btn = document.createElement('button'); 
            btn.className = 'opt-btn'; 
            btn.innerText = text;
            btn.onclick = () => {
                const allBtns = document.querySelectorAll('.opt-btn');
                allBtns.forEach(b => b.classList.add('disabled'));
                if(i === task.c) {
                    btn.classList.add('correct');
                    score += 150;
                } else {
                    btn.classList.add('wrong');
                    allBtns[task.c].classList.add('correct');
                }
                setTimeout(() => {
                    updateUI(); 
                    gameState = 'PLAY'; 
                    document.getElementById('quiz-overlay').style.display = 'none'; 
                    resetGameScene();
                }, 1200); 
            };
            optDiv.appendChild(btn);
        });
        document.getElementById('quiz-overlay').style.display = 'flex';
    }

    const handleStart = (e) => { 
        if(e.target.tagName.toLowerCase() === 'button' || e.target.closest('#editor-overlay')) return;
        if(gameState === 'PLAY') mouse.down = true; 
        updateMousePos(e); 
    };
    
    const handleEnd = (e) => {
        if(e.target.tagName.toLowerCase() === 'button' || e.target.closest('#editor-overlay')) return;
        if(mouse.down && !note.active && gameState === 'PLAY') {
            note.active = true; const sx = cupid.x + 20, sy = cupid.y + 70;
            note.x = sx; note.y = sy;
            const angle = Math.atan2(sy - mouse.y, sx - mouse.x);
            const dist = Math.hypot(sx - mouse.x, sy - mouse.y);
            const force = Math.min(
